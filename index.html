<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observatorio de Partículas del TOA - Prof. Rosa</title>
    <style>
        body { 
            font-family: Georgia, "Times New Roman", serif; 
            text-align: center; 
            margin-top: 50px; 
            background-color: #1E90FF; /* Azul Dodger para mayor contraste */
            color: #FFFFFF; /* Letras blancas */
        }
        .data { 
            font-size: 1.8em; 
            margin: 15px; 
            padding: 15px; 
            background-color: rgba(255, 255, 255, 0.3); /* Fondo semi-transparente más oscuro */
            border-radius: 10px; 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); /* Sombra más pronunciada */
        }
        h1 { 
            color: #FFFFFF; 
            font-size: 2.5em; 
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5); /* Sombra más fuerte para contraste */
        }
        canvas { 
            max-width: 100%; 
            margin: 20px auto; 
            border: 3px solid #FFFFFF; /* Borde blanco más grueso */
            border-radius: 10px;
            background-color: #FFFFFF; /* Fondo blanco opaco para máximo contraste */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Observatorio de Partículas del TOA - Datos en Tiempo Real</h1>
    <div class="data" id="realParticles">Partículas Reales: Cargando...</div>
    <div class="data" id="imaginaryParticles">Partículas Imaginarias: Cargando...</div>
    <div class="data" id="molecularPhysics">Física Molecular: Cargando...</div>
    <div class="data" id="x">x: Cargando...</div>
    <div class="data" id="y">y: Cargando...</div>
    <div class="data" id="z">z: Cargando...</div>
    <div class="data" id="angle">Ángulo: Cargando...</div>
    <div class="data" id="seismicParticles">Partículas Sísmicas: Cargando...</div>

    <canvas id="realParticlesChart" width="800" height="400"></canvas>
    <canvas id="imaginaryParticlesChart" width="800" height="400"></canvas>
    <canvas id="molecularPhysicsChart" width="800" height="400"></canvas>
    <canvas id="xChart" width="800" height="400"></canvas>
    <canvas id="yChart" width="800" height="400"></canvas>
    <canvas id="zChart" width="800" height="400"></canvas>
    <canvas id="angleChart" width="800" height="400"></canvas>
    <canvas id="seismicParticlesChart" width="800" height="400"></canvas>

    <script>
        const channelID = 2439912; // Tu Channel ID
        const readAPIKey = 'BCX6UVTLQZ7VMK4F'; // Tu Read API Key
        // Calcular fecha de 1 de marzo de 2025 y hora actual
        const marchStart = new Date('2025-03-01T00:00:00');
        const startDate = marchStart.toISOString().slice(0, 10); // Formato YYYY-MM-DD
        const now = new Date();
        const endDate = now.toISOString().slice(0, 19); // Formato YYYY-MM-DDTHH:MM:SS
        const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&start=${startDate}T00:00:00&end=${endDate}&results=8000`; // Desde 1 de marzo hasta ahora

        // Datos para los gráficos
        let realParticlesData = { labels: [], datasets: [{ label: 'Partículas Reales', data: [], borderColor: '#36A2EB', fill: false }] };
        let imaginaryParticlesData = { labels: [], datasets: [{ label: 'Partículas Imaginarias', data: [], borderColor: '#FF6384', fill: false }] };
        let molecularPhysicsData = { labels: [], datasets: [{ label: 'Física Molecular', data: [], borderColor: '#4BC0C0', fill: false }] };
        let xData = { labels: [], datasets: [{ label: 'x', data: [], borderColor: '#FF9F40', fill: false }] };
        let yData = { labels: [], datasets: [{ label: 'y', data: [], borderColor: '#9966FF', fill: false }] };
        let zData = { labels: [], datasets: [{ label: 'z', data: [], borderColor: '#FFCD56', fill: false }] };
        let angleData = { labels: [], datasets: [{ label: 'Ángulo', data: [], borderColor: '#C9CBCF', fill: false }] };
        let seismicParticlesData = { labels: [], datasets: [{ label: 'Partículas Sísmicas', data: [], borderColor: '#36A2EB', fill: false }] }; // Reutilizo color para destacar

        // Inicialización de los gráficos
        let realParticlesChart, imaginaryParticlesChart, molecularPhysicsChart, xChart, yChart, zChart, angleChart, seismicParticlesChart;

        function updateCharts() {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Error en la respuesta de la API');
                    return response.json();
                })
                .then(data => {
                    const feeds = data.feeds; // Del más antiguo al más reciente
                    if (!feeds || feeds.length === 0) throw new Error('No hay datos disponibles');

                    // Obtener todas las etiquetas y filtrar solo las asociadas a datos válidos
                    const labels = feeds.map(f => new Date(f.created_at).toLocaleString());
                    const validIndices = labels.map((_, i) => feeds[i].field1 || feeds[i].field2 || feeds[i].field3 || feeds[i].field4 || feeds[i].field5 || feeds[i].field6 || feeds[i].field7 || feeds[i].field8).map((v, i) => v ? i : -1).filter(i => i !== -1);

                    // Filtrar etiquetas y datos para incluir todos los puntos válidos
                    realParticlesData.labels = validIndices.map(i => labels[i]);
                    realParticlesData.datasets[0].data = feeds.map(f => f.field1).filter(v => v && v !== 0);
                    imaginaryParticlesData.labels = validIndices.map(i => labels[i]);
                    imaginaryParticlesData.datasets[0].data = feeds.map(f => f.field2).filter(v => v && v !== 0);
                    molecularPhysicsData.labels = validIndices.map(i => labels[i]);
                    molecularPhysicsData.datasets[0].data = feeds.map(f => f.field3).filter(v => v && v !== 0);
                    xData.labels = validIndices.map(i => labels[i]);
                    xData.datasets[0].data = feeds.map(f => f.field4).filter(v => v && v !== 0);
                    yData.labels = validIndices.map(i => labels[i]);
                    yData.datasets[0].data = feeds.map(f => f.field5).filter(v => v && v !== 0);
                    zData.labels = validIndices.map(i => labels[i]);
                    zData.datasets[0].data = feeds.map(f => f.field6).filter(v => v && v !== 0);
                    angleData.labels = validIndices.map(i => labels[i]);
                    angleData.datasets[0].data = feeds.map(f => f.field7).filter(v => v && v !== 0);
                    seismicParticlesData.labels = validIndices.map(i => labels[i]);
                    seismicParticlesData.datasets[0].data = feeds.map(f => f.field8).filter(v => v && v !== 0);

                    // Asegura que las etiquetas coincidan con los datos filtrados
                    realParticlesData.labels = realParticlesData.labels.slice(0, realParticlesData.datasets[0].data.length);
                    imaginaryParticlesData.labels = imaginaryParticlesData.labels.slice(0, imaginaryParticlesData.datasets[0].data.length);
                    molecularPhysicsData.labels = molecularPhysicsData.labels.slice(0, molecularPhysicsData.datasets[0].data.length);
                    xData.labels = xData.labels.slice(0, xData.datasets[0].data.length);
                    yData.labels = yData.labels.slice(0, yData.datasets[0].data.length);
                    zData.labels = zData.labels.slice(0, zData.datasets[0].data.length);
                    angleData.labels = angleData.labels.slice(0, angleData.datasets[0].data.length);
                    seismicParticlesData.labels = seismicParticlesData.labels.slice(0, seismicParticlesData.datasets[0].data.length);

                    // Inicializa o actualiza los gráficos
                    if (!realParticlesChart) {
                        realParticlesChart = new Chart(document.getElementById('realParticlesChart').getContext('2d'), { type: 'line', data: realParticlesData });
                        imaginaryParticlesChart = new Chart(document.getElementById('imaginaryParticlesChart').getContext('2d'), { type: 'line', data: imaginaryParticlesData });
                        molecularPhysicsChart = new Chart(document.getElementById('molecularPhysicsChart').getContext('2d'), { type: 'line', data: molecularPhysicsData });
                        xChart = new Chart(document.getElementById('xChart').getContext('2d'), { type: 'line', data: xData });
                        yChart = new Chart(document.getElementById('yChart').getContext('2d'), { type: 'line', data: yData });
                        zChart = new Chart(document.getElementById('zChart').getContext('2d'), { type: 'line', data: zData });
                        angleChart = new Chart(document.getElementById('angleChart').getContext('2d'), { type: 'line', data: angleData });
                        seismicParticlesChart = new Chart(document.getElementById('seismicParticlesChart').getContext('2d'), { type: 'line', data: seismicParticlesData });
                    } else {
                        realParticlesChart.update();
                        imaginaryParticlesChart.update();
                        molecularPhysicsChart.update();
                        xChart.update();
                        yChart.update();
                        zChart.update();
                        angleChart.update();
                        seismicParticlesChart.update();
                    }

                    // Actualiza los valores en pantalla con el dato más reciente, mostrando "Estación en reposo" si no hay datos
                    const latestData = feeds[feeds.length - 1] || {};
                    document.getElementById('realParticles').textContent = `Partículas Reales: ${latestData.field1 !== undefined && latestData.field1 !== null && latestData.field1 !== '' ? latestData.field1 : 'Estación en reposo'}`;
                    document.getElementById('imaginaryParticles').textContent = `Partículas Imaginarias: ${latestData.field2 !== undefined && latestData.field2 !== null && latestData.field2 !== '' ? latestData.field2 : 'Estación en reposo'}`;
                    document.getElementById('molecularPhysics').textContent = `Física Molecular: ${latestData.field3 !== undefined && latestData.field3 !== null && latestData.field3 !== '' ? latestData.field3 : 'Estación en reposo'}`;
                    document.getElementById('x').textContent = `x: ${latestData.field4 !== undefined && latestData.field4 !== null && latestData.field4 !== '' ? latestData.field4 : 'Estación en reposo'}`;
                    document.getElementById('y').textContent = `y: ${latestData.field5 !== undefined && latestData.field5 !== null && latestData.field5 !== '' ? latestData.field5 : 'Estación en reposo'}`;
                    document.getElementById('z').textContent = `z: ${latestData.field6 !== undefined && latestData.field6 !== null && latestData.field6 !== '' ? latestData.field6 : 'Estación en reposo'}`;
                    document.getElementById('angle').textContent = `Ángulo: ${latestData.field7 !== undefined && latestData.field7 !== null && latestData.field7 !== '' ? latestData.field7 : 'Estación en reposo'}`;
                    document.getElementById('seismicParticles').textContent = `Partículas Sísmicas: ${latestData.field8 !== undefined && latestData.field8 !== null && latestData.field8 !== '' ? latestData.field8 : 'Estación en reposo'}`;
                })
                .catch(error => {
                    console.error('Error al obtener datos:', error);
                    // Mostrar "Estación en reposo" si hay un error o no hay datos
                    document.getElementById('realParticles').textContent = `Partículas Reales: Estación en reposo`;
                    document.getElementById('imaginaryParticles').textContent = `Partículas Imaginarias: Estación en reposo`;
                    document.getElementById('molecularPhysics').textContent = `Física Molecular: Estación en reposo`;
                    document.getElementById('x').textContent = `x: Estación en reposo`;
                    document.getElementById('y').textContent = `y: Estación en reposo`;
                    document.getElementById('z').textContent = `z: Estación en reposo`;
                    document.getElementById('angle').textContent = `Ángulo: Estación en reposo`;
                    document.getElementById('seismicParticles').textContent = `Partículas Sísmicas: Estación en reposo`;
                });
        }

        // Actualiza cada 15 segundos (límite gratuito de ThingSpeak)
        setInterval(updateCharts, 15000);
        updateCharts(); // Primera carga inmediata
    </script>
</body>
</html>
